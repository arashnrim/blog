---
import Hero from "@components/Hero.astro";
import PostCard from "@components/PostCard.astro";
import BaseLayout from "@layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const topics = await getCollection("topics");
  return topics.map((topic) => ({
    params: { slug: topic.id },
    props: { topic },
  }));
}

type Topic = CollectionEntry<"topics">;

const { topic } = Astro.props;
let posts = await getCollection("posts");
posts = posts.filter((post) =>
  post.data.topics?.map((topicRef) => topicRef.id).includes(topic.id)
);
posts = posts.sort((a, b) => {
  const aDate = a.data.updatedDate || a.data.publishedDate;
  const bDate = b.data.updatedDate || b.data.publishedDate;
  return (bDate?.valueOf() ?? 0) - (aDate?.valueOf() ?? 0);
});
---

<BaseLayout>
  <Hero>
    <h1 class="title">
      {topic.data.name}
    </h1>
    <span>{topic.data.description}</span>
    {topic.data.icon && <Icon name={topic.data.icon} />}
  </Hero>

  <!-- <section id="search-container" class="container">
    <Search />
  </section> -->

  <section id="posts" class="container">
    {posts.map((post) => <PostCard post={post} />)}
  </section>
</BaseLayout>

<style>
  #search-container {
    padding-bottom: 0;
  }

  #posts {
    display: flex;
    flex-direction: column;
    gap: 1.5em;
  }

  [data-icon] {
    position: absolute;
    height: 256px;
    width: auto;
    left: 10%;
    bottom: 7.5%;
    opacity: 0.1;
    z-index: -1;
  }

  @media screen and (min-width: 1024px) {
    #posts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media screen and (min-width: 1536px) {
    #posts {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
